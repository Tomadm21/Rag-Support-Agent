# Workflow Overview

## Core Workflows

### Ticket Processing Pipeline

This is the primary workflow where a support ticket is analyzed and a response is generated.

```mermaid
sequenceDiagram
  participant User
  participant UI as Frontend (React)
  participant API as Backend (FastAPI)
  participant Graph as LangGraph Orchestrator
  participant Agents as Specialist Agents
  participant DB as Weaviate

  User->>UI: Selects Ticket & Clicks 'Generate'
  UI->>API: POST /api/copilot (Ticket Content)
  API->>Graph: Initialize State & Run
  Graph->>Agents: 1. Classify Category & Sentiment
  Graph->>DB: 2. Retrieve Relevant Context
  DB-->>Graph: Document Chunks
  Graph->>Agents: 3. Generate Draft Response
  Graph->>Agents: 4. Validate Quality & Score
  Graph-->>API: Final State (Draft + Metadata)
  API-->>UI: Streaming Response (SSE)
  UI-->>User: Display Draft with Metadata
```

### Data Flow for RAG

The knowledge base ingestion and retrieval flow ensures the model has access to the latest company information.

```mermaid
flowchart LR
    Docs[Markdown Docs] --> Ingest[Scripts / API]
    Ingest --> Vectorize[OpenAI Embeddings]
    Vectorize --> Weaviate[(Weaviate DB)]
    
    Query[Customer Query] --> Search[NearText Search]
    Weaviate --> Search
    Search --> Context[Relevant Chunks]
    Context --> Generator[LLM Generation]
```

## Error Handling

- **Agent Failure**: If an agent fails to generate a response, the workflow falls back to a "Human Review Required" state with a generic message.
- **Database Connection**: If Weaviate is unreachable, the system attempts to generate a response without RAG context (if appropriate) or flags a connection error.
- **Rate Limiting**: The system handles LLM rate limits by implementing retry logic in the agent chains.

## State Management

The `TicketState` object is passed between agents and updated at each step. This allows for:
1.  **Observability**: Each agent's output can be logged and inspected.
2.  **Persistence**: The state can be saved to a database for long-running workflows or late review.
3.  **Critique & Repair**: The Validator agent can modify the state if it detects poor quality, triggering a re-generation loop if necessary.
